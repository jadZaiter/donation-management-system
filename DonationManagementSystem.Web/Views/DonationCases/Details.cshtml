@using Microsoft.AspNetCore.Identity
@inject UserManager<IdentityUser> UserManager
@model DonationManagementSystem.Domain.Entities.DonationCase

@{
    ViewData["Title"] = "Case Details";

    var collected = Model.Donations.Sum(d => d.Amount);
    var pct = Model.TargetAmount <= 0 ? 0 : (int)Math.Min(100, Math.Round((double)(collected / Model.TargetAmount * 100)));
    var isClosed = collected >= Model.TargetAmount;
}

<h2>@Model.Title</h2>
@if (!string.IsNullOrWhiteSpace(Model.ImagePath))
{
    <a href="@Model.ImagePath" target="_blank">
        <img src="@Model.ImagePath"
             class="img-fluid rounded mb-3"
             style="max-height: 420px; object-fit: cover; width: 100%; cursor: zoom-in;" />
    </a>
}
else
{
    <div class="text-muted mb-3">No image provided.</div>
}
<small class="text-muted">Click image to view full size</small>

<p>@Model.Description</p>
@if (Model.Status == DonationManagementSystem.Domain.Entities.CaseStatus.Approved)
{
    <div class="alert alert-info">
        <strong>Verified by admin</strong>
        @if (Model.ReviewedAt != null)
        {
            <span>on @Model.ReviewedAt.Value.ToString("yyyy-MM-dd HH:mm")</span>
        }

        @if (!string.IsNullOrWhiteSpace(Model.AdminNote))
        {
            <div class="mt-2"><strong>Note:</strong> @Model.AdminNote</div>
        }
    </div>
}


<hr />

<p><strong>Collected:</strong> @collected</p>
<p><strong>Target:</strong> @Model.TargetAmount</p>

<div class="progress mb-3">
    <div class="progress-bar bg-success" role="progressbar" style="width:@pct%"></div>
</div>

@if (TempData["Message"] != null)
{
    <div class="alert alert-success">@TempData["Message"]</div>
}
@if (TempData["Error"] != null)
{
    <div class="alert alert-danger">@TempData["Error"]</div>
}

<h4>Donate to this case</h4>

@if (User.Identity != null && User.Identity.IsAuthenticated)
{
    <form asp-action="Donate" method="post">
        @Html.AntiForgeryToken()
        <input type="hidden" name="caseId" value="@Model.Id" />

        <div class="mb-3">
            <label class="form-label">Amount</label>
            <input class="form-control" type="number" name="amount" step="0.01" min="1" required />
        </div>

        <button class="btn btn-primary" @(isClosed ? "disabled" : "")>
            Donate
        </button>

        @if (isClosed)
        {
            <div class="alert alert-success mt-2">
                Target reached. Donations are closed.
            </div>
        }
    </form>
    <hr />

    <h4>Comments</h4>

    @if (Model.Comments.Any())
    {
        <ul class="list-group mb-3">
            @foreach (var c in Model.Comments.OrderByDescending(x => x.CreatedAt))
            {
                var user = await UserManager.FindByIdAsync(c.UserId);
                var email = user?.Email ?? "anonymous";
                var username = email.Contains("@") ? email.Split('@')[0] : email;

                <li class="list-group-item">
                    <div class="small text-muted">
                        @username • @c.CreatedAt.ToString("yyyy-MM-dd HH:mm")
                    </div>
                    <div>@c.Text</div>
                </li>
            }
        </ul>
    }
    else
    {
        <p>No comments yet.</p>
    }


    @if (User.Identity != null && User.Identity.IsAuthenticated)
    {
        <form asp-action="AddComment" method="post">
            @Html.AntiForgeryToken()
            <input type="hidden" name="caseId" value="@Model.Id" />

            <div class="mb-3">
                <label class="form-label">Add a comment</label>
                <textarea class="form-control" name="text" rows="3" required></textarea>
            </div>

            <button class="btn btn-primary">Post Comment</button>
        </form>
    }
    else
    {
        <p>Please <a href="/Identity/Account/Login">login</a> to comment.</p>
    }

}
else
{
    <p>Please <a href="/Identity/Account/Login">login</a> to donate.</p>
}
